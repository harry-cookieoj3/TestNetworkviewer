
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Viewer</title>
    <script id="gem_network_data" type="application/json">
    {
      "config": {
        "scale": 2.5,
        "nodeSize": 3,
        "edgeWidth": 1.2,
        "fontSize": 12
      },
      "nodes": [

["id", "label", "tags", "mod", "x", "y", "size", "color", "img1", "img2", "img3", "url1", "url2", "url3", "maker"],

              ],
      "edges": [
        ["source", "target"],
["1102199", "1087872"],
["1102199", "1044982"],
["1102327", "1086580"],
["1102327", "1080873"],
["1102327", "1087872"],
["1102327", "1093791"],
["1102327", "1102199"],
["1102327", "1060824"],
["1102327", "1088420"],
["1102327", "1092582"],
["1102327", "1085750"],
["1102327", "1084112"],
["1104612", "1092662"],
["1104612", "1093790"],
["1104612", "1044864"],
["1104612", "1096639"],
["1104612", "14754"],
["1104612", "1087778"],
["1104612", "1102197"],
["1105407", "1106862"],
["1105407", "1099472"],
["1105407", "1085397"],
["1105407", "1107481"],
["1105407", "1063724"],
["1105407", "1075010"],
["1105407", "1092997"],
["1105407", "1084337"],
["1105407", "1063214"],
["1105407", "1068671"],
["1105409", "1075464"],
["1105409", "1072127"],
["1105409", "1092427"],
["1105409", "1075302"],
["1105409", "1094993"],
["1105409", "1087621"],
["1105409", "1044864"],
["1105409", "1106862"],
["1105409", "1092662"],
["1105409", "1086581"],
["1106652", "1059080"],
["1106652", "1092662"],
["1106652", "1097983"],
["1106652", "1086581"],
["1106652", "1094993"],
["1106652", "1107481"],
["1106652", "1075302"],
["1106652", "1085628"],
["1106652", "1092427"],
["1106652", "1075464"],
["1106862", "1105407"],
["1106862", "1085397"],
["1106862", "1099472"],
["1106862", "1099846"],
["1106862", "1107481"],
["1106862", "1061063"],
["1106862", "1084346"],
["1106862", "1068671"],
["1106862", "1094993"],
["1106862", "1084337"],
["1107481", "1075464"],
["1107481", "1099846"],
["1107481", "1105407"],
["1107481", "1106862"],
["1107481", "1094993"],
["1107481", "1072127"],
["1107481", "1099472"],
["1107481", "1096639"],
["1107481", "1097983"],
["1107481", "1092662"]
      ]
    }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Helvetica Neue', Arial, sans-serif; background: #fff; color: #333; }
        #cy { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #ui-layer { position: absolute; top: 15px; left: 15px; z-index: 100; display: flex; flex-direction: column; gap: 8px; width: 280px; }
        .search-container { position: relative; }
        #node-search { width: 100%; padding: 12px; border: 2px solid #333; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: rgba(255, 255, 255, 0.9); }
        #search-results { position: absolute; top: 100%; left: 0; width: 100%; background: #fff; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none; z-index: 101; border-radius: 0 0 8px 8px; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-item:hover { background: #f0f0f0; }
        .btn { padding: 10px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #side-panel { position: absolute; right: -400px; top: 0; width: 350px; height: 100%; background: rgba(255, 255, 255, 0.98); box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 200; transition: 0.4s; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        #side-panel.open { right: 0; }
@media screen and (max-width: 768px) {
    #side-panel {
        right: 0;
        left: 0;
        bottom: -100%;
        top: auto;
        width: 100%;
        
        /* ここを調整！ */
        max-height: 85vh; /* 60vhから85vh（8.5割）に引き上げ */
        
        border-radius: 20px 20px 0 0;
        padding: 20px;
        /* 指でスクロールした時の挙動をスムーズに */
        -webkit-overflow-scrolling: touch; 
        /* 下端がブラウザのメニューバーに被らないよう余白を追加 */
        padding-bottom: 60px; 
    }
    #side-panel.open {
        bottom: 0;
    }
}

        /* 画像スイッチャー */
        .gem_img_viewer { width: 100%; margin-bottom: 10px; }
        .gem_main_img { width: 100%; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .gem_thumb_container { display: flex; justify-content: center; gap: 8px; margin-top: 8px; }
        .gem_thumb { width: 50px; height: 50px; border-radius: 4px; border: 2px solid transparent; object-fit: cover; cursor: pointer; opacity: 0.6; }
        .gem_thumb.active { border-color: #ff7045; opacity: 1; }

        /* 作品ボタン & メーカーリンク */
        .gem_maker_link { color: #ff7045; text-decoration: underline; font-size: 12px; margin-right: 8px; display: inline-block; margin-bottom: 4px; }
        .gem_work_btn { display: block; width: 100%; padding: 10px; margin-bottom: 8px; text-align: center; text-decoration: none; font-weight: bold; border-radius: 6px; font-size: 13px; }
        .btn_url1 { background: #ff7045; color: #fff; }
        .btn_url2 { background: #555; color: #fff; }
        .btn_url3 { background: #999; color: #fff; }
        #status-log { position: absolute; bottom: 5px; left: 5px; z-index: 100; background: rgba(0,0,0,0.6); color: #0f0; padding: 5px 10px; font-size: 10px; pointer-events: none; }

/* リンク化されたタグのスタイル */
.gem_tag_link {
    background: #f4f4f4; 
    color: #333; 
    padding: 3px 10px; 
    border-radius: 4px; 
    font-size: 11px; 
    text-decoration: none; 
    transition: 0.2s;
    border: 1px solid #ddd;
    display: inline-block;
}
.gem_tag_link:hover {
    background: #ff7045;
    color: #fff;
    border-color: #ff7045;
}
/* 女優名リンクのスタイル */
.gem_label_link {
    color: #333;
    text-decoration: none;
    transition: 0.2s;
    display: inline-block;
}
.gem_label_link:hover {
    color: #ff7045;
}
/* ×ボタンのスタイル調整 */
.gem_close_btn {
    float: right; 
    cursor: pointer; 
    font-size: 36px; /* 24pxから拡大 */
    color: #999; 
    line-height: 1;
    padding: 10px; /* タップ範囲を広げる */
    margin-top: -10px;
    margin-right: -10px;
}
    </style>
</head>
<body>
    <div id="ui-layer">
        <div class="search-container">
            <input type="text" id="node-search" placeholder="女優検索..." autocomplete="off">
            <div id="search-results"></div>
        </div>
        <button class="btn" onclick="resetSelection()">全体を表示 / 解除</button>
    </div>
    <div id="side-panel"></div>
    <div id="status-log">Initializing...</div>
    <div id="cy"></div>

    <script>
    (function(){
        let cy;
        const logEl = document.getElementById('status-log');
        const searchInput = document.getElementById('node-search');
        const searchResults = document.getElementById('search-results');
        const sidePanel = document.getElementById('side-panel');

        const addLog = (msg) => { logEl.innerText = msg; };
        const getEmbeddedData = () => JSON.parse(document.getElementById('gem_network_data').textContent);

        function adjustView(animate = true) {
            if (!cy) return;
            cy.animate({ fit: { eles: cy.elements(), padding: window.innerWidth < 768 ? 30 : 60 } }, { duration: animate ? 600 : 0 });
        }

        async function start() {
            addLog("データ読み込み中...");
            try {
                const fullData = getEmbeddedData();
                const dataConf = fullData.config || { scale: 1, nodeSize: 5, fontSize: 12, edgeWidth: 1.5 };
                const elements = [];
                const nHeaders = fullData.nodes[0];
                const nodeRows = fullData.nodes.slice(1);
                
                nodeRows.forEach(row => {
                    const n = Object.fromEntries(row.map((val, i) => [nHeaders[i], val]));
                    elements.push({
                        group: 'nodes',
                        data: { 
                            id: String(n.id), label: n.label, color: n.color,
                            size: parseFloat(n.size) * dataConf.nodeSize,
                            tags: n.tags, img1: n.img1, img2: n.img2, img3: n.img3,
                            url1: n.url1, url2: n.url2, url3: n.url3, maker: n.maker
                        },
                        position: { 
                            x: parseFloat(n.x) * dataConf.scale, 
                            y: parseFloat(n.y) * -dataConf.scale 
                        }
                    });
                });

                const nodeIds = new Set(nodeRows.map(row => String(row[0])));
                fullData.edges.slice(1).forEach(row => {
                    if (nodeIds.has(String(row[0])) && nodeIds.has(String(row[1]))) {
                        elements.push({ group: 'edges', data: { source: String(row[0]), target: String(row[1]) } });
                    }
                });

                cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    minZoom: 0.05, maxZoom: 1.5,
                    style: [
                        { selector: 'node', style: { 
                            'width': 'data(size)', 'height': 'data(size)', 'label': 'data(label)', 
                            'font-size': dataConf.fontSize, 'background-color': 'data(color)',
                            'text-outline-width': 1.5, 'text-outline-color': '#fff', 'text-valign': 'bottom', 'text-margin-y': 4
                        }},
                        { selector: 'edge', style: { 'width': dataConf.edgeWidth, 'line-color': '#ccc', 'opacity': 0.3, 'curve-style': 'haystack' }},
                        { selector: '.faded', style: { 'opacity': 0.08, 'text-opacity': 0 }},
                        { selector: '.highlight-node', style: { 'z-index': 999, 'border-width': 4, 'border-color': '#333' }},
                        { selector: '.edge-out', style: { 'line-color': '#ff4d4d', 'opacity': 0.8 }},
                        { selector: '.edge-in', style: { 'line-color': '#4d79ff', 'opacity': 0.8 }}
                    ],
                    layout: { name: 'preset' }
                });

                cy.on('tap', 'node', (e) => { selectNode(e.target); openPanel(e.target.data()); });
                
                searchInput.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    searchResults.innerHTML = '';
                    if (!val) { searchResults.style.display = 'none'; return; }
                    const matches = cy.nodes().filter(n => n.data('label') && n.data('label').includes(val));
                    if (matches.length > 0) {
                        searchResults.style.display = 'block';
                        matches.slice(0, 8).forEach(m => {
                            const div = document.createElement('div');
                            div.className = 'search-item'; div.innerText = m.data('label');
                            div.onmousedown = (ev) => {
                                ev.preventDefault();
                                selectNode(m); openPanel(m.data());
                                cy.animate({ center: { eles: m }, zoom: 0.8 }, { duration: 800 });
                                searchResults.style.display = 'none';
                            };
                            searchResults.appendChild(div);
                        });
                    } else { searchResults.style.display = 'none'; }
                });

                adjustView(false);
                addLog(`描画完了: ${nodeRows.length} nodes`);
            } catch (err) { addLog("Error: " + err.message); }
        }

        function selectNode(node) {
            cy.elements().addClass('faded').removeClass('highlight-node edge-out edge-in');
            node.removeClass('faded').addClass('highlight-node');
            node.connectedEdges().forEach(edge => {
                edge.removeClass('faded');
                if (edge.source().id() === node.id()) edge.addClass('edge-out'); else edge.addClass('edge-in');
            });
            node.neighborhood().nodes().removeClass('faded');
        }

        window.openPanel = function(data) {
            const afId = "ntanalisis-990";
            const images = [data.img1, data.img2, data.img3].filter(s => s && s.length > 5);
            const urls = [data.url1, data.url2, data.url3];

            const actressUrl = `https://al.fanza.co.jp/?lurl=${encodeURIComponent('https://www.dmm.co.jp/search/=/searchstr=' + data.label + '/')}&af_id=${afId}&ch=api`;

            const tagLinks = data.tags ? data.tags.split(',').map(t => {
                const name = t.trim();
                const url = `https://al.fanza.co.jp/?lurl=${encodeURIComponent('https://www.dmm.co.jp/search/=/searchstr=' + name + '/')}&af_id=${afId}&ch=api`;
                return `<a href="${url}" target="_blank" class="gem_tag_link">${name}</a>`;
            }).join('') : '';

            const makerLinks = data.maker ? data.maker.split(',').map(m => {
                const name = m.trim();
                const url = `https://al.fanza.co.jp/?lurl=${encodeURIComponent('https://www.dmm.co.jp/search/=/searchstr=' + name + '/')}&af_id=${afId}&ch=api`;
                return `<a href="${url}" target="_blank" class="gem_maker_link">${name}</a>`;
            }).join('') : '---';

            let imgHTML = '';
            if (images.length > 0) {
                imgHTML += `
                    <div class="gem_img_viewer">
                        <a id="gem_image_link" href="${urls[0]}" target="_blank">
                            <img id="main_img" src="${images[0]}" class="gem_main_img">
                        </a>
                    </div>
                    <a id="gem_main_button" href="${urls[0]}" target="_blank" class="gem_work_btn btn_url1">
                        作品の詳細をチェック
                    </a>`;

                if (images.length > 1) {
                    imgHTML += `<div class="gem_thumb_container">` + images.map((s, i) => 
                        `<img src="${s}" class="gem_thumb ${i===0?'active':''}" onclick="changeImg(this, '${s}', '${urls[i]}')">`
                    ).join('') + `</div>`;
                }
            }

            sidePanel.innerHTML = `
                <span class="gem_close_btn" onclick="closePanel()">×</span>
                <h2 style="margin:0 0 15px 0; font-size:22px; padding-right:40px;">
                    <a href="${actressUrl}" target="_blank" class="gem_label_link">${data.label}</a>
                </h2>
                <div style="margin-bottom:15px;">
                    <p style="font-size:10px; color:#999; margin-bottom:5px; border-bottom:1px solid #eee;">TAGS (属性検索)</p>
                    <div style="display:flex; flex-wrap:wrap; gap:6px;">${tagLinks}</div>
                </div>
                ${imgHTML}
                <div style="margin-top:20px; padding-top:10px; border-top:1px dashed #ddd;">
                    <p style="font-size:10px; color:#999; margin-bottom:5px;">MAKER (所属/レーベル)</p>
                    <div style="display:flex; flex-wrap:wrap; gap:4px;">${makerLinks}</div>
                </div>
            `;
            sidePanel.classList.add('open');
        };

        window.changeImg = function(el, src, targetUrl) {
            document.getElementById('main_img').src = src;
            document.getElementById('gem_image_link').href = targetUrl;
            document.getElementById('gem_main_button').href = targetUrl;
            document.querySelectorAll('.gem_thumb').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        };

        window.closePanel = function() { sidePanel.classList.remove('open'); };

        window.resetSelection = function() {
            const isFocused = cy.elements('.faded').length > 0;
            if (isFocused) {
                cy.elements().removeClass('faded highlight-node edge-out edge-in');
                addLog("フォーカスを解除しました");
            } else {
                closePanel();
                searchInput.value = '';
                adjustView(true);
                addLog("全体表示に戻りました");
            }
        };
        
        window.addEventListener('resize', () => adjustView(true));
        start();
    })();
    </script>
</body>
</html>

